<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — Dashboard</title>
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --accent: #2dd4bf;
            --muted: #9aa6b2;
            --text: #e6eef3;
            --nav: #071029;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(180deg, #071024 0%, #081827 100%);
            color: var(--text);
            min-height: 100vh;
        }

        header {
            background: var(--nav);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.02)
        }

        .brand {
            font-weight: 700;
            letter-spacing: 0.4px
        }

        nav {
            display: flex;
            gap: 8px;
            margin-left: auto
        }

        nav a {
            color: var(--muted);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        nav a.active {
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.12), rgba(99, 102, 241, 0.06));
            color: var(--accent);
            box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.25)
        }

        main {
            padding: 28px;
            max-width: 1200px;
            margin: 18px auto;
        }

        .page-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px
        }

        h1 {
            margin: 0;
            font-size: 20px
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.03);
            padding: 16px;
            border-radius: 10px;
        }

        .checks {
            margin-top: 8px;
            padding-left: 14px;
        }

        .check-item {
            margin-bottom: 6px;
            font-size: 13px;
        }

        .check-name {
            font-weight: 600;
            display: inline-block;
            margin-right: 8px;
        }

        .regex-list {
            margin-top: 6px;
            padding-left: 12px;
            font-size: 13px;
            color: var(--muted);
        }

        .regex-item {
            display: flex;
            gap: 8px;
            align-items: baseline;
            margin-bottom: 4px;
        }

        .status-pass {
            color: #10b981;
            font-weight: 600;
        }

        .status-fail {
            color: #f97316;
            font-weight: 600;
        }

        /* Button styles are provided in /static/admin.css */

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        .hero {
            padding: 18px;
            border-radius: 12px;
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.06), rgba(99, 102, 241, 0.03));
            border: 1px solid rgba(45, 212, 191, 0.06);
            margin-bottom: 18px;
        }

        footer {
            color: var(--muted);
            text-align: center;
            padding: 18px 0;
            font-size: 13px
        }

        a.route {
            cursor: pointer
        }

        @media (max-width:640px) {
            header {
                padding: 10px
            }

            nav {
                gap: 6px
            }

            nav a {
                padding: 6px 8px;
                font-size: 13px
            }
        }
    </style>
    <link rel="stylesheet" href="/static/admin.css">
    <style>
        /* Minimal scrollbar styling for history containers */
        .minimal-scroll {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.12) transparent;
        }

        .minimal-scroll::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .minimal-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .minimal-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.12);
            border-radius: 6px;
        }

        /* Fancy form controls for scoring adjustments */
        .fancy-input,
        .fancy-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* force these styles even if inline styles are present on elements */
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01)) !important;
            border: 1px solid rgba(255, 255, 255, 0.06) !important;
            color: var(--text) !important;
            padding: 8px 12px !important;
            border-radius: 8px !important;
            outline: none;
            box-shadow: none;
            transition: box-shadow 120ms ease, border-color 120ms ease;
        }

        .fancy-input:focus,
        .fancy-select:focus {
            border-color: rgba(45, 212, 191, 0.6);
            box-shadow: 0 4px 16px rgba(45, 212, 191, 0.06);
        }

        /* add a subtle dropdown arrow for fancy selects */
        .fancy-select {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23e6eef3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>") !important;
            background-repeat: no-repeat !important;
            background-position: right 10px center !important;
            background-size: 14px 14px !important;
            padding-right: 36px !important;
        }

        /* Attempt to style native option popup (limited support) */
        .fancy-select option {
            background: var(--card);
            color: var(--text);
        }

        /* On some browsers, you can style the dropdown via select::-ms-expand (IE) or use shadow DOM -- limited */
        select::-ms-expand {
            display: none;
        }

        /* If you need full control of open-list styling, use a custom select component instead */
    </style>
</head>

<body>
    <header>
        <div class="brand">BlueDevil Admin</div>
        <nav id="admin-nav" aria-label="Admin menu">
            <a href="/admin/" data-path="/" class="route" id="nav-dashboard">Dashboard</a>
            <a href="/admin/services" data-path="/services" class="route" id="nav-services">Services</a>
            <a href="/admin/box-mapping" data-path="/box-mapping" class="route" id="nav-boxmapping">Box Mapping</a>
            <a href="/admin/scores" data-path="/scores" class="route" id="nav-scores">Scores</a>
            <a href="/admin/injects" data-path="/injects" class="route" id="nav-injects">Injects</a>
            <a href="/admin/competitions" data-path="/competitions" class="route" id="nav-competitions">Competitions</a>
            <a href="/admin/users" data-path="/users" class="route" id="nav-users">Users</a>
            <a href="/admin/teams" data-path="/teams" class="route" id="nav-teams">Teams</a>
        </nav>
    </header>

    <main>
        <section id="view-dashboard" data-view>
            <div class="page-title">
                <h1>Dashboard</h1>
                <div class="muted">Overview and service configuration status</div>
            </div>

            <div class="card" style="max-width:100%;margin-top:18px">
                <h3>Service Configuration Matrix</h3>
                <div class="muted" style="margin-bottom:12px">Shows which services are configured for each team. Green =
                    Configured with IP mapping, Red = Not configured</div>
                <div id="service-matrix-container" style="overflow-x:auto">
                    <div class="muted">Loading service matrix...</div>
                </div>
            </div>
        </section>

        <section id="view-services" data-view hidden>
            <div class="page-title">
                <h1>Services</h1>
                <div class="muted">Manage Scored Services</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div class="muted">Manage Scored Services</div>
                <div>
                    <button id="add-service-btn" class="btn btn-primary">+ Add Service</button>
                </div>
            </div>

            <hr style="margin:18px 0;border-color:rgba(255,255,255,0.04)">

            <!-- (Team mapping UI removed — boxes now store team_id and service_id directly) -->



            <div class="grid" id="services-grid" aria-live="polite">
                <div class="card muted">Loading services…</div>
            </div>

            <!-- Inline editor panel (hidden until used) -->
            <div id="service-editor" class="card" style="display:none;max-width:900px;margin-top:18px">
                <h3 id="editor-title">Edit Service</h3>
                <div style="display:flex;gap:12px;flex-wrap:wrap">
                    <label style="flex:1 1 300px">Name<br><input id="svc-name" style="width:100%"></label>
                    <label style="flex:1 1 120px">ID (optional)<br><input id="svc-id" type="number" min="1"
                            style="width:100%" readonly></label>
                </div>
                <div style="margin-top:8px">
                    <strong>Checks</strong>
                    <div id="checks-list" style="margin-top:8px"></div>
                    <button id="add-check-btn" class="btn btn-ghost" style="margin-top:8px">+ Add Check</button>
                </div>

                <div style="margin-top:12px;display:flex;gap:8px">
                    <button id="save-service-btn" class="btn btn-primary">Save</button>
                    <button id="cancel-service-btn" class="btn btn-ghost">Cancel</button>
                </div>
            </div>

            <script>
                (function () {
                    const container = document.getElementById('services-grid');

                    function makeCard(service) {
                        const card = document.createElement('div');
                        card.className = 'card';

                        const title = document.createElement('strong');
                        title.textContent = service.name || service.service || 'Unnamed Service';

                        card.appendChild(title);

                        // hint: commands can include the placeholder {{host}} which will be
                        // replaced by the service host when executing checks.

                        // If the service has an explicit `checks` array, render each check.
                        if (Array.isArray(service.checks) && service.checks.length > 0) {
                            const list = document.createElement('div');
                            list.className = 'checks muted';

                            service.checks.forEach(check => {
                                const item = document.createElement('div');
                                item.className = 'check-item';

                                const name = document.createElement('span');
                                name.className = 'check-name';
                                name.textContent = check.name || check.id || 'check';

                                const commandText = check.command ?? check.cmd ?? check.scoreCommand ?? '';
                                const cmd = document.createElement('span');
                                cmd.textContent = typeof commandText === 'string' ? commandText : JSON.stringify(commandText);
                                cmd.className = 'muted';

                                item.appendChild(name);
                                item.appendChild(cmd);


                                // Render regex expectations if present
                                if (Array.isArray(check.regexes) && check.regexes.length > 0) {
                                    const regexList = document.createElement('div');
                                    regexList.className = 'regex-list';

                                    // map results by id for quick lookup
                                    const resultsById = {};
                                    if (Array.isArray(check.regexResults)) {
                                        check.regexResults.forEach(r => { resultsById[r.id] = r });
                                    }

                                    check.regexes.forEach(rx => {
                                        const rxItem = document.createElement('div');
                                        rxItem.className = 'regex-item';

                                        const res = resultsById[rx.id];
                                        const status = document.createElement('span');
                                        status.className = res && res.matched ? 'status-pass' : 'status-pass';
                                        status.textContent = res ? (res.matched ? 'PASS' : 'FAIL') : 'PASS';

                                        const desc = document.createElement('span');
                                        desc.textContent = rx.description ? rx.description + ' — ' + rx.pattern : rx.pattern;

                                        rxItem.appendChild(status);
                                        rxItem.appendChild(desc);

                                        // If matched, show the captured match (short)
                                        if (res && res.matched && res.match) {
                                            const matched = document.createElement('div');
                                            matched.className = 'muted';
                                            matched.style.marginLeft = '10px';
                                            matched.textContent = `Matched: ${res.match}`;
                                            rxItem.appendChild(matched);
                                        }

                                        regexList.appendChild(rxItem);
                                    });

                                    item.appendChild(regexList);
                                }

                                list.appendChild(item);
                            });

                            card.appendChild(list);
                            return card;
                        }

                        // Backwards-compatible single command field
                        const cmd = document.createElement('div');
                        cmd.className = 'muted';
                        const commandText = service.command ?? service.cmd ?? service.scoreCommand ?? '';
                        cmd.textContent = typeof commandText === 'string' ? commandText : JSON.stringify(commandText);

                        card.appendChild(cmd);
                        return card;
                    }

                    function render(services) {
                        container.innerHTML = '';
                        if (!services || services.length === 0) {
                            container.innerHTML = '<div class="card"><strong>No services</strong><div class="muted">No services returned</div></div>';
                            return;
                        }
                        services.forEach(s => container.appendChild(makeCard(s)));
                        adjustColumns();
                    }

                    function adjustColumns() {
                        // Ensure grid is at most 3 columns, each at least ~220px
                        const width = container.clientWidth || container.parentElement.clientWidth || window.innerWidth;
                        const approxColWidth = 220; // minimum column width
                        const columns = Math.min(3, Math.max(1, Math.floor(width / approxColWidth)));
                        container.style.display = 'grid';
                        container.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
                        container.style.gap = '14px';
                    }

                    // Helper: coerce incoming service IDs (and nested ids where present) to numbers
                    function normalizeServices(arr) {
                        if (!Array.isArray(arr)) return [];
                        return arr.map(s => {
                            const svc = Object.assign({}, s);
                            if (svc.id !== undefined && svc.id !== null) svc.id = Number(svc.id);
                            // normalize checks ids if present
                            if (Array.isArray(svc.checks)) {
                                svc.checks = svc.checks.map(c => {
                                    const cc = Object.assign({}, c);
                                    if (cc.id !== undefined && cc.id !== null) cc.id = Number(cc.id);
                                    if (Array.isArray(cc.regexes)) {
                                        cc.regexes = cc.regexes.map(r => {
                                            const rr = Object.assign({}, r);
                                            if (rr.id !== undefined && rr.id !== null) rr.id = Number(rr.id);
                                            return rr;
                                        });
                                    }
                                    return cc;
                                });
                            }
                            return svc;
                        });
                    }



                    // Fetch services from API and render
                    fetch('/api/admin/services', { credentials: 'same-origin' })
                        .then(res => {
                            if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
                            return res.json();
                        })
                        .then(data => {
                            // Accept either an array or an object with a services property
                            const services = Array.isArray(data) ? data : (data.services || []);
                            render(normalizeServices(services));
                        })
                        .catch(err => {
                            container.innerHTML = '<div class="card"><strong>Error</strong><div class="muted">Failed to load services</div></div>';
                            console.error('Failed to load services:', err);
                        });

                    window.addEventListener('resize', adjustColumns);

                    // --- Editor UI code ---
                    const editor = document.getElementById('service-editor');
                    const svcNameInput = document.getElementById('svc-name');
                    const svcIdInput = document.getElementById('svc-id');
                    const checksList = document.getElementById('checks-list');
                    const addServiceBtn = document.getElementById('add-service-btn');
                    const addCheckBtn = document.getElementById('add-check-btn');
                    const saveServiceBtn = document.getElementById('save-service-btn');
                    const cancelServiceBtn = document.getElementById('cancel-service-btn');

                    function openEditor(service) {
                        // service can be null for a new service
                        editor.style.display = 'block';
                        svcNameInput.value = service?.name || '';
                        svcIdInput.value = (service && service.id !== undefined && service.id !== null) ? Number(service.id) : '';
                        checksList.innerHTML = '';
                        const checks = Array.isArray(service?.checks) ? service.checks : [];
                        checks.forEach(c => checksList.appendChild(buildCheckEditor(c)));
                    }

                    function closeEditor() {
                        editor.style.display = 'none';
                        svcNameInput.value = '';
                        svcIdInput.value = '';
                        checksList.innerHTML = '';
                    }

                    function buildCheckEditor(check) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'card';
                        wrapper.style.marginBottom = '8px';

                        const name = document.createElement('input');
                        name.placeholder = 'Check name';
                        name.value = check?.name || '';
                        name.style.width = '100%';

                        const cmd = document.createElement('input');
                        cmd.placeholder = 'Command';
                        cmd.value = check?.command || '';
                        cmd.style.width = '100%';
                        cmd.style.marginTop = '6px';

                        const rxContainer = document.createElement('div');
                        rxContainer.style.marginTop = '8px';
                        rxContainer.appendChild(document.createTextNode('Regexes'));

                        const rxList = document.createElement('div');
                        rxList.style.marginTop = '6px';
                        rxContainer.appendChild(rxList);

                        const addRxBtn = document.createElement('button');
                        addRxBtn.textContent = '+ Add regex';
                        addRxBtn.className = 'btn btn-ghost';
                        addRxBtn.style.marginTop = '6px';
                        addRxBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            rxList.appendChild(buildRegexEditor());
                        });

                        // populate existing regexes
                        if (Array.isArray(check?.regexes)) {
                            check.regexes.forEach(rx => rxList.appendChild(buildRegexEditor(rx)));
                        }

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'Remove check';
                        removeBtn.className = 'btn btn-danger';
                        removeBtn.style.marginTop = '8px';
                        removeBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            wrapper.remove();
                        });

                        wrapper.appendChild(name);
                        wrapper.appendChild(cmd);
                        wrapper.appendChild(rxContainer);
                        wrapper.appendChild(addRxBtn);
                        wrapper.appendChild(removeBtn);

                        // store metadata
                        wrapper._getData = () => {
                            const rxEls = Array.from(rxList.children || []).map(rxEl => rxEl._getData());
                            return { name: name.value, command: cmd.value, regexes: rxEls };
                        };

                        return wrapper;
                    }

                    function buildRegexEditor(rx) {
                        const w = document.createElement('div');
                        w.style.display = 'flex';
                        w.style.gap = '6px';
                        w.style.marginBottom = '6px';

                        const pat = document.createElement('input');
                        pat.placeholder = 'pattern';
                        pat.value = rx?.pattern || '';
                        pat.style.flex = '1';

                        const desc = document.createElement('input');
                        desc.placeholder = 'description';
                        desc.value = rx?.description || '';
                        desc.style.flex = '1';

                        const remove = document.createElement('button');
                        remove.textContent = 'x';
                        remove.className = 'btn btn-danger';
                        remove.addEventListener('click', (e) => { e.preventDefault(); w.remove(); });

                        w.appendChild(pat);
                        w.appendChild(desc);
                        w.appendChild(remove);

                        w._getData = () => ({ pattern: pat.value, description: desc.value });
                        return w;
                    }

                    addServiceBtn.addEventListener('click', () => openEditor(null));
                    addCheckBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        checksList.appendChild(buildCheckEditor({}));
                    });

                    cancelServiceBtn.addEventListener('click', (e) => { e.preventDefault(); closeEditor(); });

                    saveServiceBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const svc = { name: svcNameInput.value };
                        if (svcIdInput.value) svc.id = Number(svcIdInput.value);
                        const checks = Array.from(checksList.children || []).map(c => c._getData());
                        svc.checks = checks;

                        try {
                            const res = await fetch('/api/admin/services', {
                                method: 'POST',
                                credentials: 'same-origin',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(svc)
                            });
                            if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
                            await refreshServices();
                            closeEditor();
                        } catch (err) {
                            console.error('Failed to save service', err);
                            alert('Failed to save service: ' + err.message);
                        }
                    });

                    async function refreshServices() {
                        try {
                            const res = await fetch('/api/admin/services', { credentials: 'same-origin' });
                            if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
                            const data = await res.json();
                            const services = Array.isArray(data) ? data : (data.services || []);
                            render(services);
                        } catch (err) {
                            console.error('Failed to refresh services', err);
                        }
                    }

                    // expose edit button on each card: wrap makeCard usage
                    const originalMakeCard = makeCard;
                    function makeCardWithEdit(service) {
                        const card = originalMakeCard(service);
                        const toolbar = document.createElement('div');
                        toolbar.style.display = 'flex';
                        toolbar.style.justifyContent = 'flex-end';
                        toolbar.style.marginTop = '8px';

                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Edit';
                        editBtn.className = 'btn-ghost';
                        editBtn.style.marginRight = '8px';
                        editBtn.addEventListener('click', (e) => { e.preventDefault(); openEditor(service); });

                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Delete';
                        delBtn.className = 'btn btn-danger';
                        delBtn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            if (!confirm('Delete service "' + (service.name || '') + '"?')) return;
                            try {
                                const res = await fetch('/api/admin/services', {
                                    method: 'DELETE',
                                    credentials: 'same-origin',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: Number(service.id) })
                                });
                                if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
                                await refreshServices();
                            } catch (err) {
                                console.error('Failed to delete service', err);
                                alert('Failed to delete service');
                            }
                        });

                        toolbar.appendChild(editBtn);
                        toolbar.appendChild(delBtn);
                        card.appendChild(toolbar);
                        return card;
                    }

                    // replace render to use edit-enabled cards
                    function render(services) {
                        container.innerHTML = '';
                        if (!services || services.length === 0) {
                            container.innerHTML = '<div class="card"><strong>No services</strong><div class="muted">No services returned</div></div>';
                            return;
                        }
                        services.forEach(s => container.appendChild(makeCardWithEdit(s)));
                        adjustColumns();
                    }
                })();
            </script>
        </section>

        <section id="view-box-mapping" data-view hidden>
            <div class="page-title">
                <h1>Box Mapping</h1>
                <div class="muted">Enter IP addresses for each Team × Service. Leave empty to remove mapping.</div>
            </div>

            <div class="card" style="overflow:auto">
                <div id="box-matrix-controls"
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <strong>Team / Service Matrix</strong>
                    <div class="muted">Click a cell to edit the IP address. Changes are saved automatically.</div>
                </div>

                <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <label style="display:flex;flex-direction:column;font-size:13px;color:var(--muted)">Service
                            <select id="bulk-service"
                                style="min-width:220px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)"></select>
                        </label>

                        <label
                            style="display:flex;flex-direction:column;flex:1;min-width:300px;font-size:13px;color:var(--muted)">Template
                            <input id="bulk-template" placeholder="e.g. 10.0.{{ add 39 team }}.9 or 10.0.{{ team }}.5"
                                style="width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:var(--text)">
                        </label>

                        <button id="bulk-preview" class="btn btn-ghost">Preview</button>
                        <button id="bulk-apply" class="btn btn-primary">Apply to all teams</button>
                    </div>
                    <div id="bulk-preview-area" class="muted" style="font-size:13px"></div>
                </div>

                <div id="box-matrix-container" style="min-width:600px;overflow:auto">
                    <div class="muted">Loading matrix...</div>
                </div>
            </div>

            <style>
                /* small styles scoped to the matrix view */
                #box-matrix-container table {
                    width: 100%;
                    border-collapse: collapse;
                }

                #box-matrix-container th,
                #box-matrix-container td {
                    padding: 8px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
                }

                .matrix-team-col {
                    position: sticky;
                    left: 0;
                    background: var(--card);
                    font-weight: 600;
                    z-index: 5;
                }

                .matrix-header-team {
                    position: sticky;
                    left: 0;
                    background: var(--card);
                    z-index: 10;
                }

                .matrix-input {
                    width: 100%;
                    padding: 6px 8px;
                    border-radius: 6px;
                    border: 1px solid rgba(255, 255, 255, 0.04);
                    background: rgba(255, 255, 255, 0.01);
                    color: var(--text);
                }

                .matrix-input.saving {
                    box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.08) inset;
                }

                .matrix-input.error {
                    box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.12) inset;
                }

                /* preview badge inside cells */
                .matrix-preview {
                    display: block;
                    margin-top: 6px;
                    font-size: 13px;
                    color: #ffffff;
                    background: rgba(45, 212, 191, 0.12);
                    padding: 6px 8px;
                    border-radius: 8px;
                    font-weight: 600;
                    max-width: 220px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }

                /* selected service dropdown text color */
                select.has-selection {
                    color: var(--accent);
                    font-weight: 700;
                }

                @media (max-width:900px) {
                    #box-matrix-container {
                        min-width: 900px;
                    }
                }
            </style>

            <script>
                (function () {
                    const container = document.getElementById('box-matrix-container');
                    let teams = [];
                    let services = [];
                    // mapping indexed by teamId -> serviceId -> mapping object
                    let boxMap = {};
                    // helpers for debouncing saves per input
                    const saveTimers = new Map();

                    async function loadMatrix() {
                        container.innerHTML = '<div class="muted">Loading matrix...</div>';
                        try {
                            const res = await fetch('/api/admin/service-matrix', { credentials: 'same-origin' });
                            if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
                            const data = await res.json();
                            teams = data.teams || [];
                            services = data.services || [];
                            boxMap = data.box_map || {};
                            renderMatrix();
                        } catch (err) {
                            console.error('Failed to load matrix', err);
                            container.innerHTML = '<div class="muted">Failed to load matrix</div>';
                        }
                    }

                    function renderMatrix() {
                        if (!teams.length || !services.length) {
                            container.innerHTML = '<div class="muted">No teams or services configured.</div>';
                            return;
                        }

                        const table = document.createElement('table');

                        // header
                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        const thTeam = document.createElement('th');
                        thTeam.className = 'matrix-header-team';
                        thTeam.textContent = 'Team \u2014 Service';
                        headerRow.appendChild(thTeam);

                        services.forEach(svc => {
                            const th = document.createElement('th');
                            th.style.textAlign = 'center';
                            th.textContent = svc.name || svc.service || ('svc-' + (svc.id || ''));
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        table.appendChild(thead);

                        // body
                        const tbody = document.createElement('tbody');
                        teams.forEach(team => {
                            const tr = document.createElement('tr');
                            const teamCell = document.createElement('td');
                            teamCell.className = 'matrix-team-col';
                            teamCell.textContent = team.name || ('team-' + team.id);
                            tr.appendChild(teamCell);

                            services.forEach(svc => {
                                const td = document.createElement('td');
                                td.style.textAlign = 'center';

                                const existing = (boxMap[team.id] && boxMap[team.id][svc.id]) || null;
                                const input = document.createElement('input');
                                input.className = 'matrix-input';
                                input.value = existing && existing.ip_address ? existing.ip_address : '';
                                input.dataset.teamId = team.id;
                                input.dataset.serviceId = svc.id;
                                if (existing && existing.id) input.dataset.mappingId = existing.id;

                                // save on blur or after small debounce
                                input.addEventListener('input', () => scheduleSave(input));
                                input.addEventListener('blur', () => doImmediateSave(input));

                                td.appendChild(input);
                                tr.appendChild(td);
                            });

                            tbody.appendChild(tr);
                        });

                        table.appendChild(tbody);
                        container.innerHTML = '';
                        container.appendChild(table);
                    }

                    function scheduleSave(input) {
                        const key = input.dataset.teamId + ':' + input.dataset.serviceId;
                        if (saveTimers.has(key)) clearTimeout(saveTimers.get(key));
                        // quick debounce to avoid rapid requests while typing
                        saveTimers.set(key, setTimeout(() => { saveTimers.delete(key); saveCell(input); }, 600));
                    }

                    function doImmediateSave(input) {
                        const key = input.dataset.teamId + ':' + input.dataset.serviceId;
                        if (saveTimers.has(key)) { clearTimeout(saveTimers.get(key)); saveTimers.delete(key); }
                        saveCell(input);
                    }

                    async function saveCell(input) {
                        const teamId = Number(input.dataset.teamId);
                        const serviceId = Number(input.dataset.serviceId);
                        const ip = (input.value || '').trim();
                        const mappingId = input.dataset.mappingId ? Number(input.dataset.mappingId) : null;

                        // visual feedback
                        input.classList.remove('error');
                        input.classList.add('saving');

                        try {
                            if (!ip) {
                                // delete mapping if exists
                                const existing = boxMap[teamId] && boxMap[teamId][serviceId];
                                if (!existing) {
                                    input.classList.remove('saving');
                                    return; // nothing to do
                                }

                                // Prefer deletion by id if available
                                if (existing.id) {
                                    const delRes = await fetch('/api/admin/boxes', {
                                        method: 'DELETE',
                                        credentials: 'same-origin',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ id: existing.id })
                                    });
                                    if (!delRes.ok) throw new Error('Delete failed: ' + delRes.status);
                                } else {
                                    // fallback: attempt delete by team/service
                                    const delRes = await fetch('/api/admin/boxes', {
                                        method: 'DELETE',
                                        credentials: 'same-origin',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ team_id: teamId, service_id: serviceId })
                                    });
                                    if (!delRes.ok) throw new Error('Delete failed: ' + delRes.status);
                                }

                                // remove from local map and clear mappingId
                                if (boxMap[teamId]) { delete boxMap[teamId][serviceId]; }
                                delete input.dataset.mappingId;
                                input.classList.remove('saving');
                                return;
                            }

                            // create/update mapping via POST
                            const payload = { team_id: teamId, service_id: serviceId, ip_address: ip };
                            if (mappingId) payload.id = mappingId;

                            const res = await fetch('/api/admin/boxes', {
                                method: 'POST',
                                credentials: 'same-origin',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (!res.ok) throw new Error('Save failed: ' + res.status);

                            // Try to read returned mapping object
                            let saved = null;
                            try { saved = await res.json(); } catch (e) { /* ignore */ }

                            // Update local map
                            boxMap[teamId] = boxMap[teamId] || {};
                            if (saved && saved.id) {
                                boxMap[teamId][serviceId] = saved;
                                input.dataset.mappingId = saved.id;
                            } else {
                                // best-effort minimal mapping
                                boxMap[teamId][serviceId] = { ip_address: ip };
                            }

                            input.classList.remove('saving');
                        } catch (err) {
                            console.error('Failed to save mapping', err);
                            input.classList.remove('saving');
                            input.classList.add('error');
                        }
                    }

                    // Expose hook for router when view becomes visible
                    window.onBoxMappingVisible = async function () { await loadMatrix(); populateBulkService(); };

                    // Load immediately if visible
                    const section = document.getElementById('view-box-mapping');
                    if (section && !section.hasAttribute('hidden')) (async () => { await loadMatrix(); populateBulkService(); })();

                    // Bulk controls
                    const bulkServiceSel = document.getElementById('bulk-service');
                    const bulkTemplateInput = document.getElementById('bulk-template');
                    const bulkPreviewBtn = document.getElementById('bulk-preview');
                    const bulkApplyBtn = document.getElementById('bulk-apply');
                    const bulkPreviewArea = document.getElementById('bulk-preview-area');

                    function populateBulkService() {
                        if (!bulkServiceSel) return;
                        bulkServiceSel.innerHTML = '';
                        services.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s.id;
                            opt.textContent = s.name || s.service || ('svc-' + s.id);
                            bulkServiceSel.appendChild(opt);
                        });
                        // mark selection styling
                        if (bulkServiceSel.value) bulkServiceSel.classList.add('has-selection'); else bulkServiceSel.classList.remove('has-selection');
                    }

                    // Simple evaluator supporting patterns like {{ add 39 team }} and {{ team }}
                    function evalTemplateForTeam(tmpl, teamId) {
                        if (!tmpl || tmpl.indexOf('{{') === -1) return tmpl;
                        // handle occurrences of {{ ... }}
                        return tmpl.replace(/{{\s*([^}]+)\s*}}/g, (_, expr) => {
                            try {
                                // tokenize by whitespace
                                const parts = expr.trim().split(/\s+/);
                                if (parts.length === 1) {
                                    // single token like 'team' or a number
                                    if (parts[0] === 'team') return String(teamId);
                                    const n = Number(parts[0]); return isNaN(n) ? parts[0] : String(n);
                                }
                                // function form: op a b ... (we only support add, sub, mul, div)
                                const op = parts[0];
                                const args = parts.slice(1).map(p => p === 'team' ? Number(teamId) : Number(p));
                                if (args.some(a => typeof a !== 'number' || isNaN(a))) return '{{' + expr + '}}';
                                switch (op) {
                                    case 'add': return String(args.reduce((a, b) => a + b, 0));
                                    case 'sub': return String(args.slice(1).reduce((a, b) => a - b, args[0]));
                                    case 'mul':
                                    case 'multiply':
                                    case 'times': return String(args.reduce((a, b) => a * b, 1));
                                    case 'div': return String(args.slice(1).reduce((a, b) => a / b, args[0]));
                                    default: return '{{' + expr + '}}';
                                }
                            } catch (e) {
                                return '{{' + expr + '}}';
                            }
                        });
                    }

                    bulkPreviewBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const svcId = Number(bulkServiceSel.value || 0);
                        const tmpl = (bulkTemplateInput.value || '').trim();
                        if (!svcId || !tmpl) { bulkPreviewArea.textContent = 'Choose a service and enter a template.'; return; }
                        // render preview badges into each table cell for the selected service
                        teams.forEach(t => {
                            const preview = evalTemplateForTeam(tmpl, t.id);
                            const inputEl = document.querySelector(`input.matrix-input[data-team-id="${t.id}"][data-service-id="${svcId}"]`);
                            if (inputEl && inputEl.parentElement) {
                                let badge = inputEl.parentElement.querySelector('.matrix-preview');
                                if (!badge) { badge = document.createElement('span'); badge.className = 'matrix-preview'; inputEl.parentElement.appendChild(badge); }
                                badge.textContent = preview;
                            }
                        });
                        bulkPreviewArea.textContent = 'Preview applied to table (colored badges).';
                        // mark select as styled
                        bulkServiceSel.classList.add('has-selection');
                    });

                    // style the select when changed
                    if (bulkServiceSel) {
                        bulkServiceSel.addEventListener('change', () => {
                            if (bulkServiceSel.value) bulkServiceSel.classList.add('has-selection'); else bulkServiceSel.classList.remove('has-selection');
                        });
                    }

                    bulkApplyBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const svcId = Number(bulkServiceSel.value || 0);
                        const tmpl = (bulkTemplateInput.value || '').trim();
                        if (!svcId || !tmpl) { alert('Choose a service and enter a template.'); return; }

                        if (!confirm('Apply this template to all teams for the selected service? This will create/update IPs for each team.')) return;

                        // For each team, compute IP and save via POST (or DELETE if blank)
                        for (const t of teams) {
                            const ip = evalTemplateForTeam(tmpl, t.id).trim();
                            // find existing mapping in boxMap
                            const existing = (boxMap[t.id] && boxMap[t.id][svcId]) || null;
                            const inputEl = document.querySelector(`input.matrix-input[data-team-id="${t.id}"][data-service-id="${svcId}"]`);
                            if (inputEl) {
                                inputEl.value = ip;
                                // trigger a save (immediate)
                                try { await saveCell(inputEl); } catch (e) { console.error('bulk save failed for team', t.id, e); }
                            } else {
                                // no direct input found, perform POST directly
                                try {
                                    if (!ip) {
                                        if (existing && existing.id) {
                                            await fetch('/api/admin/boxes', { method: 'DELETE', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: existing.id }) });
                                        }
                                        continue;
                                    }
                                    const payload = { team_id: t.id, service_id: svcId, ip_address: ip };
                                    if (existing && existing.id) payload.id = existing.id;
                                    await fetch('/api/admin/boxes', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                                } catch (err) { console.error('bulk direct save failed', err); }
                            }
                        }

                        // Refresh matrix after apply
                        await loadMatrix();
                        populateBulkService();
                        alert('Bulk apply complete.');
                    });
                })();
            </script>
        </section>

        <section id="view-scores" data-view hidden>
            <div class="page-title">
                <h1>Scores</h1>
                <div class="muted">View and edit scores</div>
            </div>
            <div class="card" style="max-width:1000px">
                <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
                    <div style="display:flex;gap:8px;align-items:center">
                        <label style="font-size:13px;color:var(--muted)">Team
                            <select id="scores-team"
                                style="margin-left:8px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)"></select>
                        </label>
                        <label style="font-size:13px;color:var(--muted)">Service
                            <select id="scores-service"
                                style="margin-left:8px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)"></select>
                        </label>
                        <button id="scores-refresh" class="btn btn-ghost">Refresh</button>
                    </div>
                    <div class="muted">Select a team and service to view check history and outputs</div>
                </div>

                <div id="scores-history" class="minimal-scroll"
                    style="max-height:360px;overflow:auto;border-top:1px solid rgba(255,255,255,0.04);padding-top:12px">
                    <div class="muted">No history loaded</div>
                </div>

                <hr style="margin:12px 0;border-color:rgba(255,255,255,0.04)">

                <div style="margin-top:8px">
                    <h3>Add Scoring Adjustment</h3>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <label style="flex:1;min-width:200px">Team<br><select id="adj-team" class="fancy-select"
                                style="width:100%"></select></label>
                        <label style="width:140px">Points<br><input id="adj-points" class="fancy-input" type="number"
                                value="0" style="width:100%"></label>
                        <label style="width:140px">Round (optional)<br><input id="adj-round" class="fancy-input"
                                type="number" style="width:100%"></label>
                        <label style="flex:2;min-width:220px">Reason<br><input id="adj-desc" class="fancy-input"
                                style="width:100%"></label>
                        <div>
                            <button id="adj-submit" class="btn btn-primary">Add Adjustment</button>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                (function () {
                    const teamSel = document.getElementById('scores-team');
                    const svcSel = document.getElementById('scores-service');
                    const historyDiv = document.getElementById('scores-history');
                    const refreshBtn = document.getElementById('scores-refresh');

                    const adjTeam = document.getElementById('adj-team');
                    const adjPoints = document.getElementById('adj-points');
                    const adjRound = document.getElementById('adj-round');
                    const adjDesc = document.getElementById('adj-desc');
                    const adjSubmit = document.getElementById('adj-submit');

                    let teams = [];
                    let services = [];

                    async function loadSelectors() {
                        const [tRes, sRes] = await Promise.all([
                            fetch('/api/admin/teams', { credentials: 'same-origin' }),
                            fetch('/api/admin/services', { credentials: 'same-origin' })
                        ]);
                        teams = await tRes.json();
                        services = await sRes.json();
                        teamSel.innerHTML = '';
                        adjTeam.innerHTML = '';
                        teams.forEach(t => { teamSel.appendChild(new Option(t.name, t.id)); adjTeam.appendChild(new Option(t.name, t.id)); });
                        svcSel.innerHTML = '';
                        services.forEach(s => svcSel.appendChild(new Option(s.name || s.service || s.name, s.id)));
                    }

                    async function loadHistory() {
                        const teamId = Number(teamSel.value || 0);
                        const svcId = Number(svcSel.value || 0);
                        if (!teamId || !svcId) { historyDiv.innerHTML = '<div class="muted">Select team and service to view history</div>'; return; }
                        historyDiv.innerHTML = '<div class="muted">Loading history...</div>';
                        try {
                            const res = await fetch(`/api/admin/score-history?team_id=${teamId}&service_id=${svcId}`, { credentials: 'same-origin' });
                            if (!res.ok) throw new Error(res.statusText);
                            const rows = await res.json();
                            renderHistory(rows);
                        } catch (err) { console.error(err); historyDiv.innerHTML = '<div class="muted">Failed to load history</div>'; }
                    }

                    function renderHistory(rows) {
                        if (!rows || rows.length === 0) { historyDiv.innerHTML = '<div class="muted">No history for this selection</div>'; return; }
                        const table = document.createElement('table');
                        table.style.width = '100%';
                        table.style.borderCollapse = 'collapse';
                        const thead = document.createElement('thead');
                        const hr = document.createElement('tr');
                        ['Round', 'Status', 'Output'].forEach(t => { const th = document.createElement('th'); th.textContent = t; th.style.textAlign = 'left'; th.style.padding = '8px'; th.style.borderBottom = '1px solid rgba(255,255,255,0.06)'; hr.appendChild(th); });
                        thead.appendChild(hr);
                        table.appendChild(thead);
                        const tbody = document.createElement('tbody');
                        // show most recent entries at the top
                        const ordered = Array.isArray(rows) ? rows.slice().reverse() : rows;
                        ordered.forEach(r => {
                            const tr = document.createElement('tr');
                            const roundTd = document.createElement('td'); roundTd.textContent = r.round; roundTd.style.padding = '8px'; tr.appendChild(roundTd);
                            const statusTd = document.createElement('td'); statusTd.style.padding = '8px';
                            const img = document.createElement('img'); img.width = 20; img.height = 20; img.alt = r.is_up ? 'UP' : 'DOWN'; img.src = r.is_up ? '/static/up.png' : '/static/down.png'; statusTd.appendChild(img); tr.appendChild(statusTd);
                            const outTd = document.createElement('td'); outTd.style.padding = '8px'; const pre = document.createElement('pre'); pre.textContent = r.output || ''; pre.style.whiteSpace = 'pre-wrap'; pre.style.margin = '0'; outTd.appendChild(pre); tr.appendChild(outTd);
                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                        historyDiv.innerHTML = '';
                        historyDiv.appendChild(table);
                    }

                    refreshBtn.addEventListener('click', loadHistory);
                    teamSel.addEventListener('change', loadHistory);
                    svcSel.addEventListener('change', loadHistory);

                    adjSubmit.addEventListener('click', async () => {
                        const teamId = Number(adjTeam.value || 0);
                        const pts = Number(adjPoints.value || 0);
                        const rnd = Number(adjRound.value || 0);
                        const desc = (adjDesc.value || '').trim();
                        if (!teamId) return alert('Choose a team');
                        try {
                            const res = await fetch('/api/admin/score-adjust', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team_id: teamId, score: pts, round: rnd || null, description: desc }) });
                            if (!res.ok) throw new Error('Failed');
                            alert('Adjustment added');
                            // clear inputs
                            adjPoints.value = '0'; adjRound.value = ''; adjDesc.value = '';
                            loadHistory();
                        } catch (err) { console.error(err); alert('Failed to add adjustment'); }
                    });

                    // init
                    (async () => { await loadSelectors(); })();
                })();
            </script>
        </section>

        <section id="view-competitions" data-view hidden>
            <div class="page-title">
                <h1>Competition</h1>
                <div class="muted">Schedule, start, stop and reset competition</div>
            </div>

            <div class="card" style="max-width:800px">
                <h3>Competition Status</h3>
                <div id="comp-status" style="margin:12px 0">
                    <div><strong>Status:</strong> <span id="comp-status-text" class="muted">Loading...</span></div>
                    <div id="comp-scheduled-time" style="margin-top:6px;display:none">
                        <strong>Scheduled Time:</strong> <span id="comp-scheduled-text" class="muted"></span>
                    </div>
                    <div id="comp-started-time" style="margin-top:6px;display:none">
                        <strong>Started Time:</strong> <span id="comp-started-text" class="muted"></span>
                    </div>
                    <div id="comp-stopped-time" style="margin-top:6px;display:none">
                        <strong>Stopped Time:</strong> <span id="comp-stopped-text" class="muted"></span>
                    </div>
                </div>

                <hr style="margin:18px 0;border-color:rgba(255,255,255,0.04)">

                <h3>Actions</h3>

                <div style="margin-bottom:18px">
                    <label style="display:block;margin-bottom:6px"><strong>Schedule Competition</strong></label>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input type="datetime-local" id="scheduled-time-input" style="flex:1;max-width:300px">
                        <button id="schedule-btn" class="btn btn-primary">Schedule</button>
                    </div>
                    <div class="muted" style="margin-top:4px">Set a future date and time for the competition to start
                    </div>
                </div>

                <div style="display:flex;gap:8px;margin-bottom:18px">
                    <button id="start-btn" class="btn btn-primary">Start Competition</button>
                    <button id="stop-btn" class="btn btn-ghost">Stop Competition</button>
                </div>

                <hr style="margin:18px 0;border-color:rgba(255,255,255,0.04)">

                <h3 style="color:#f97316">Danger Zone</h3>
                <div style="margin-top:12px">
                    <button id="reset-btn" class="btn btn-danger">Reset Scoring Data</button>
                    <div class="muted" style="margin-top:6px">This will delete all records from the competition_scores
                        table. This action cannot be undone.</div>
                </div>
            </div>
        </section>

        <section id="view-users" data-view hidden>
            <div class="page-title">
                <h1>Users</h1>
                <div class="muted">Manage user accounts and team assignments</div>
            </div>
            <div class="card" style="max-width:1000px">
                <h3>User List</h3>
                <div class="muted" style="margin-bottom:12px">Users are automatically provisioned when they sign in.
                    Assign them to teams below.</div>
                <div id="users-list-container" style="margin-top:12px">
                    <div class="muted">Loading users...</div>
                </div>
            </div>
        </section>

        <section id="view-teams" data-view hidden>
            <div class="page-title">
                <h1>Teams</h1>
                <div class="muted">Manage teams</div>
            </div>

            <div class="card" style="max-width:800px;margin-bottom:18px">
                <h3>Create New Team</h3>
                <div style="display:flex;gap:8px;align-items:flex-end;margin-top:12px">
                    <label style="flex:1">Team name<br><input id="new-team-name" style="width:100%"></label>
                    <button id="create-team-btn" class="btn btn-primary">Create Team</button>
                </div>
            </div>

            <div class="card" style="max-width:800px">
                <h3>Team List</h3>
                <div id="team-list-container" style="margin-top:12px">
                    <div class="muted">Loading teams...</div>
                </div>
            </div>

            <!-- Team Editor Modal -->
            <div id="team-editor" class="card" style="display:none;max-width:600px;margin-top:18px">
                <h3 id="team-editor-title">Edit Team</h3>
                <div style="margin-top:12px">
                    <label>Team name<br><input id="edit-team-name" style="width:100%"></label>
                    <input type="hidden" id="edit-team-id">
                </div>
                <div style="margin-top:12px;display:flex;gap:8px">
                    <button id="save-team-btn" class="btn btn-primary">Save</button>
                    <button id="cancel-team-btn" class="btn btn-ghost">Cancel</button>
                </div>
            </div>
        </section>

        <section id="view-injects" data-view hidden>
            <div class="page-title">
                <h1>Injects</h1>
                <div class="muted">Manage injects</div>
            </div>
            <div class="card">
                <strong>Inject list</strong>
                <div class="muted">(placeholder for inject management)</div>
            </div>
        </section>
    </main>

    <footer>BlueDevil Engine Admin</footer>

    <script>
        // Client-side router with /admin base
        (function () {
            const BASE = '/admin'; // root for admin pages
            const links = document.querySelectorAll('a.route');
            const views = Array.from(document.querySelectorAll('[data-view]'));
            const nav = document.getElementById('admin-nav');

            function normalizePath(p) {
                // Accepts full path (e.g. /admin/scores) or relative data-path (e.g. /scores or /)
                if (!p) p = '/';
                if (!p.startsWith('/')) p = '/' + p;
                // If already begins with BASE
                if (p === BASE || p === BASE + '/') return BASE + '/';
                if (p.startsWith(BASE + '/')) {
                    // remove trailing slash for non-root
                    return p.endsWith('/') ? p.slice(0, -1) : p;
                }
                // Relative: map '/' -> /admin/, other -> /admin/<name>
                if (p === '/') return BASE + '/';
                return BASE + p;
            }

            function setActivePath(path, replace = false) {
                const fullPath = normalizePath(path);

                if (replace) history.replaceState({ path: fullPath }, '', fullPath);
                else history.pushState({ path: fullPath }, '', fullPath);

                // Map path -> section id (built from BASE)
                const map = {
                    [BASE + '/']: 'view-dashboard',
                    [BASE + '/services']: 'view-services',
                    [BASE + '/box-mapping']: 'view-box-mapping',
                    [BASE + '/scores']: 'view-scores',
                    [BASE + '/competitions']: 'view-competitions',
                    [BASE + '/users']: 'view-users',
                    [BASE + '/teams']: 'view-teams',
                    [BASE + '/injects']: 'view-injects',
                };
                const targetId = map[fullPath] || 'view-dashboard';

                views.forEach(v => v.hidden = (v.id !== targetId));

                // If box-mapping view is now active, call optional hook to refresh its data
                if (targetId === 'view-box-mapping' && typeof window.onBoxMappingVisible === 'function') {
                    try { window.onBoxMappingVisible(); } catch (e) { console.error('onBoxMappingVisible hook failed', e); }
                }

                // If competitions view is now active, call optional hook to refresh its data
                if (targetId === 'view-competitions' && typeof window.onCompetitionsVisible === 'function') {
                    try { window.onCompetitionsVisible(); } catch (e) { console.error('onCompetitionsVisible hook failed', e); }
                }

                // If teams view is now active, call optional hook to refresh its data
                if (targetId === 'view-teams' && typeof window.onTeamsVisible === 'function') {
                    try { window.onTeamsVisible(); } catch (e) { console.error('onTeamsVisible hook failed', e); }
                }

                // If users view is now active, call optional hook to refresh its data
                if (targetId === 'view-users' && typeof window.onUsersVisible === 'function') {
                    try { window.onUsersVisible(); } catch (e) { console.error('onUsersVisible hook failed', e); }
                }

                // If dashboard view is now active, call optional hook to refresh its data
                if (targetId === 'view-dashboard' && typeof window.onDashboardVisible === 'function') {
                    try { window.onDashboardVisible(); } catch (e) { console.error('onDashboardVisible hook failed', e); }
                }

                // Update active nav
                nav.querySelectorAll('a').forEach(a => {
                    const data = a.getAttribute('data-path') || '/';
                    const p = normalizePath(data);
                    a.classList.toggle('active', p === fullPath);
                });

                // Update title from the active section
                const titleText = document.querySelector('#' + targetId + ' h1')?.textContent || 'Dashboard';
                document.title = `Admin — ${titleText}`;
            }

            // Intercept clicks
            links.forEach(a => {
                a.addEventListener('click', function (e) {
                    const dataPath = this.getAttribute('data-path') || '/';
                    e.preventDefault();
                    setActivePath(dataPath);
                });
            });

            // Handle back/forward
            window.addEventListener('popstate', (e) => {
                const path = (e.state && e.state.path) || location.pathname || BASE + '/';
                setActivePath(path, true);
            });

            // On load, activate based on location.pathname (ensure default is /admin/)
            const initial = location.pathname && location.pathname.startsWith(BASE) ? location.pathname : BASE + '/';
            setActivePath(initial, true);
        })();
    </script>
    <script>
        (function () {
            // Apply fancy-select class to existing and future <select> elements inside the admin UI.
            function styleSelect(el) {
                if (!(el instanceof HTMLSelectElement)) return;
                // add the class if not present
                if (!el.classList.contains('fancy-select')) el.classList.add('fancy-select');
                // ensure the element isn't visually broken by inline backgrounds
                el.style.background = el.style.background || 'transparent';
                // toggle .has-selection when value is set
                function updateHasSelection() {
                    try {
                        if (el.value && String(el.value) !== '0' && el.value !== '') el.classList.add('has-selection');
                        else el.classList.remove('has-selection');
                    } catch (e) { }
                }
                el.addEventListener('change', updateHasSelection);
                updateHasSelection();
            }

            // initialize existing selects
            document.querySelectorAll('select').forEach(styleSelect);

            // Observe for future added selects (some parts of the admin UI create selects dynamically)
            const observer = new MutationObserver(muts => {
                for (const m of muts) {
                    for (const n of m.addedNodes) {
                        if (!(n instanceof Element)) continue;
                        if (n.tagName === 'SELECT') styleSelect(n);
                        // also find nested selects
                        n.querySelectorAll && n.querySelectorAll('select').forEach(styleSelect);
                    }
                }
            });

            observer.observe(document.body, { childList: true, subtree: true });
        })();
    </script>
    <script>
        (function () {
            // Simplified boxes client logic: boxes now store team_id and service_id directly
            const boxesList = document.getElementById('boxes-list');
            const addBoxBtn = document.getElementById('add-box-btn');
            const boxEditor = document.getElementById('box-editor');
            const boxIp = document.getElementById('box-ip');
            const boxTeam = document.getElementById('box-team');
            const boxService = document.getElementById('box-service');
            const saveBoxBtn = document.getElementById('save-box-btn');
            const cancelBoxBtn = document.getElementById('cancel-box-btn');

            let teams = [];
            let services = [];
            let boxes = [];
            let editingBox = null;

            async function fetchData() {
                await Promise.all([loadTeams(), loadServices(), loadBoxes()]);
                renderBoxes();
            }

            async function loadTeams() {
                const res = await fetch('/api/admin/teams', { credentials: 'same-origin' });
                teams = await res.json();
                const teamList = document.getElementById('team-list');
                if (teamList) {
                    teamList.innerHTML = '';
                    teams.forEach(t => {
                        const d = document.createElement('div');
                        d.className = 'muted';
                        d.textContent = `${t.id}: ${t.name}`;
                        teamList.appendChild(d);
                    });
                }
                const boxTeamSel = document.getElementById('box-team');
                if (boxTeamSel) {
                    boxTeamSel.innerHTML = '';
                    teams.forEach(t => boxTeamSel.appendChild(new Option(t.name, t.id)));
                }
            }

            async function loadServices() {
                const res = await fetch('/api/admin/services', { credentials: 'same-origin' });
                services = await res.json();
                if (boxService) {
                    boxService.innerHTML = '';
                    services.forEach(s => boxService.appendChild(new Option(s.name || s.service || s.name, s.id)));
                }
            }

            async function loadBoxes() {
                const res = await fetch('/api/admin/boxes', { credentials: 'same-origin' });
                boxes = await res.json();
            }

            function renderBoxes() {
                boxesList.innerHTML = '';
                if (!boxes || boxes.length === 0) boxesList.innerHTML = '<div class="card muted">No boxes</div>';
                boxes.forEach(b => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    const title = document.createElement('strong');
                    const teamName = (teams.find(x => x.id === b.team_id) || {}).name || b.team_id;
                    const svcName = (services.find(x => x.id === b.service_id) || {}).name || b.service_id || '';
                    title.textContent = `${b.ip_address} ${svcName ? '(' + svcName + ')' : ''} — team ${teamName}`;
                    card.appendChild(title);
                    const toolbar = document.createElement('div');
                    toolbar.style.marginTop = '8px';
                    toolbar.style.display = 'flex';
                    toolbar.style.justifyContent = 'flex-end';
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn-ghost';
                    editBtn.textContent = 'Edit';
                    editBtn.addEventListener('click', () => openBoxEditor(b));
                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-danger';
                    delBtn.textContent = 'Delete';
                    delBtn.addEventListener('click', async () => {
                        if (!confirm('Delete box ' + b.ip_address + '?')) return;
                        const res = await fetch('/api/admin/boxes', { method: 'DELETE', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: b.id }) });
                        if (!res.ok) return alert('Failed to delete box');
                        await loadBoxes(); renderBoxes();
                    });
                    toolbar.appendChild(editBtn); toolbar.appendChild(delBtn);
                    card.appendChild(toolbar);
                    boxesList.appendChild(card);
                });
            }

            function openBoxEditor(b) {
                editingBox = b || null;
                boxEditor.style.display = 'block';
                boxIp.value = b ? b.ip_address : '';
                boxTeam.value = b ? b.team_id : (teams[0] && teams[0].id);
                boxService.value = b ? b.service_id || '' : '';
            }

            function closeBoxEditor() { editingBox = null; boxEditor.style.display = 'none'; }

            addBoxBtn.addEventListener('click', () => openBoxEditor(null));
            cancelBoxBtn.addEventListener('click', (e) => { e.preventDefault(); closeBoxEditor(); });
            saveBoxBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const ip = (boxIp.value || '').trim();
                if (!ip) return alert('Enter box IP');
                // create or update box with team_id and service_id
                const payload = { team_id: Number(boxTeam.value || 0), ip_address: ip, service_id: Number(boxService.value || 0) };
                if (editingBox && editingBox.id) payload.id = editingBox.id;
                const res = await fetch('/api/admin/boxes', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!res.ok) return alert('Failed to save box');
                await loadBoxes(); renderBoxes(); closeBoxEditor();
            });

            // initial load
            fetchData().catch(err => console.error('box mapping load error', err));

            // Expose a hook so the router can refresh dropdowns when view is shown
            window.onBoxMappingVisible = async function () {
                try {
                    await Promise.all([loadTeams(), loadServices(), loadBoxes()]);
                    renderBoxes();
                } catch (e) {
                    console.error('onBoxMappingVisible failed', e);
                }
            };
        })();
    </script>
    <script>
        // Teams management
        (function () {
            const teamListContainer = document.getElementById('team-list-container');
            const teamEditor = document.getElementById('team-editor');
            const editTeamName = document.getElementById('edit-team-name');
            const editTeamId = document.getElementById('edit-team-id');
            const saveTeamBtn = document.getElementById('save-team-btn');
            const cancelTeamBtn = document.getElementById('cancel-team-btn');

            let allTeams = [];

            async function loadTeamsList() {
                try {
                    const res = await fetch('/api/admin/teams', { credentials: 'same-origin' });
                    if (!res.ok) throw new Error('Failed to load teams');
                    allTeams = await res.json();
                    renderTeamsList();
                } catch (err) {
                    console.error('Failed to load teams:', err);
                    teamListContainer.innerHTML = '<div class="muted">Error loading teams</div>';
                }
            }

            function renderTeamsList() {
                if (!allTeams || allTeams.length === 0) {
                    teamListContainer.innerHTML = '<div class="muted">No teams yet</div>';
                    return;
                }

                teamListContainer.innerHTML = '';
                allTeams.forEach(team => {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.justifyContent = 'space-between';
                    row.style.alignItems = 'center';
                    row.style.padding = '8px';
                    row.style.borderBottom = '1px solid rgba(255,255,255,0.04)';

                    const nameSpan = document.createElement('strong');
                    nameSpan.textContent = team.name;

                    const actions = document.createElement('div');
                    actions.style.display = 'flex';
                    actions.style.gap = '8px';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-ghost';
                    editBtn.textContent = 'Edit';
                    editBtn.addEventListener('click', () => openTeamEditor(team));

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.addEventListener('click', () => deleteTeam(team));

                    actions.appendChild(editBtn);
                    actions.appendChild(deleteBtn);

                    row.appendChild(nameSpan);
                    row.appendChild(actions);
                    teamListContainer.appendChild(row);
                });
            }

            function openTeamEditor(team) {
                editTeamId.value = team.id;
                editTeamName.value = team.name;
                teamEditor.style.display = 'block';
            }

            function closeTeamEditor() {
                teamEditor.style.display = 'none';
                editTeamId.value = '';
                editTeamName.value = '';
            }

            async function deleteTeam(team) {
                if (!confirm(`Delete team "${team.name}"? This will also remove all members from this team.`)) return;
                try {
                    const res = await fetch('/api/admin/teams', {
                        method: 'DELETE',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: team.id })
                    });
                    if (!res.ok) throw new Error('Failed to delete team');
                    await loadTeamsList();
                } catch (err) {
                    console.error('Failed to delete team:', err);
                    alert('Failed to delete team: ' + err.message);
                }
            }

            saveTeamBtn.addEventListener('click', async () => {
                const name = editTeamName.value.trim();
                const id = parseInt(editTeamId.value);
                if (!name) return alert('Enter team name');

                try {
                    const res = await fetch('/api/admin/teams', {
                        method: 'PUT',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id, name })
                    });
                    if (!res.ok) throw new Error('Failed to update team');
                    await loadTeamsList();
                    closeTeamEditor();
                } catch (err) {
                    console.error('Failed to update team:', err);
                    alert('Failed to update team: ' + err.message);
                }
            });

            cancelTeamBtn.addEventListener('click', () => closeTeamEditor());

            // Create team handler
            const createTeamBtn = document.getElementById('create-team-btn');
            const newTeamNameInput = document.getElementById('new-team-name');

            if (createTeamBtn) {
                createTeamBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const name = newTeamNameInput.value.trim();
                    if (!name) return alert('Enter team name');

                    try {
                        const res = await fetch('/api/admin/teams', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        });
                        if (!res.ok) throw new Error('Failed to create team');
                        newTeamNameInput.value = '';
                        await loadTeamsList();
                    } catch (err) {
                        console.error('Failed to create team:', err);
                        alert('Failed to create team: ' + err.message);
                    }
                });
            }

            // Load teams when the view becomes visible
            window.onTeamsVisible = async function () {
                await loadTeamsList();
            };

            // Initial load if view is already visible
            const teamsSection = document.getElementById('view-teams');
            if (teamsSection && !teamsSection.hasAttribute('hidden')) {
                loadTeamsList();
            }
        })();
    </script>
    <script>
        // Users management
        (function () {
            const usersListContainer = document.getElementById('users-list-container');

            let allUsers = [];
            let allTeams = [];

            async function loadUsersData() {
                try {
                    const [usersRes, teamsRes] = await Promise.all([
                        fetch('/api/admin/users', { credentials: 'same-origin' }),
                        fetch('/api/admin/teams', { credentials: 'same-origin' })
                    ]);
                    if (!usersRes.ok || !teamsRes.ok) throw new Error('Failed to load data');
                    allUsers = await usersRes.json() || [];
                    allTeams = await teamsRes.json() || [];
                    renderUsersList();
                } catch (err) {
                    console.error('Failed to load users:', err);
                    usersListContainer.innerHTML = '<div class="muted">Error loading users</div>';
                }
            }

            function renderUsersList() {
                if (!allUsers || allUsers.length === 0) {
                    usersListContainer.innerHTML = '<div class="muted">No users yet. Users will be created automatically when they sign in.</div>';
                    return;
                }

                const hasTeams = allTeams && allTeams.length > 0;

                // Create a table
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';

                // Header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['Name', 'Email', 'Current Team', 'Assign to Team'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    th.style.textAlign = 'left';
                    th.style.padding = '8px';
                    th.style.borderBottom = '2px solid rgba(255,255,255,0.1)';
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Body
                const tbody = document.createElement('tbody');
                allUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(255,255,255,0.04)';

                    // Name
                    const nameCell = document.createElement('td');
                    nameCell.textContent = user.name || '-';
                    nameCell.style.padding = '8px';
                    row.appendChild(nameCell);

                    // Email
                    const emailCell = document.createElement('td');
                    emailCell.textContent = user.email;
                    emailCell.style.padding = '8px';
                    row.appendChild(emailCell);

                    // Current Team
                    const teamCell = document.createElement('td');
                    teamCell.textContent = user.team_name || 'No team';
                    teamCell.style.padding = '8px';
                    teamCell.className = user.team_name ? '' : 'muted';
                    row.appendChild(teamCell);

                    // Assign to Team dropdown
                    const actionCell = document.createElement('td');
                    actionCell.style.padding = '8px';

                    const select = document.createElement('select');
                    select.style.width = '100%';
                    select.style.padding = '4px 8px';

                    if (!hasTeams) {
                        // No teams configured
                        const noTeamsOpt = document.createElement('option');
                        noTeamsOpt.value = '';
                        noTeamsOpt.textContent = '-- NO TEAMS CONFIGURED --';
                        noTeamsOpt.disabled = true;
                        noTeamsOpt.selected = true;
                        select.appendChild(noTeamsOpt);
                        select.disabled = true;
                    } else {
                        // Add "No team" option
                        const noTeamOpt = document.createElement('option');
                        noTeamOpt.value = '0';
                        noTeamOpt.textContent = '-- No team --';
                        select.appendChild(noTeamOpt);

                        // Add team options
                        allTeams.forEach(team => {
                            const opt = document.createElement('option');
                            opt.value = team.id;
                            opt.textContent = team.name;
                            if (user.team_id === team.id) {
                                opt.selected = true;
                            }
                            select.appendChild(opt);
                        });

                        // Set current value
                        if (!user.team_id) {
                            select.value = '0';
                        }

                        select.addEventListener('change', async (e) => {
                            const teamId = parseInt(e.target.value);
                            await assignUserToTeam(user.id, teamId);
                        });
                    }

                    actionCell.appendChild(select);
                    row.appendChild(actionCell);

                    tbody.appendChild(row);
                });
                table.appendChild(tbody);

                usersListContainer.innerHTML = '';
                usersListContainer.appendChild(table);
            }

            async function assignUserToTeam(userId, teamId) {
                try {
                    const res = await fetch('/api/admin/users', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userId, team_id: teamId })
                    });
                    if (!res.ok) throw new Error('Failed to assign user');
                    await loadUsersData(); // Reload to show updated team
                } catch (err) {
                    console.error('Failed to assign user:', err);
                    alert('Failed to assign user: ' + err.message);
                    await loadUsersData(); // Reload to reset dropdown
                }
            }

            // Load users when the view becomes visible
            window.onUsersVisible = async function () {
                await loadUsersData();
            };

            // Initial load if view is already visible
            const usersSection = document.getElementById('view-users');
            if (usersSection && !usersSection.hasAttribute('hidden')) {
                loadUsersData();
            }
        })();
    </script>
    <script>
        // Dashboard Service Matrix
        (function () {
            const matrixContainer = document.getElementById('service-matrix-container');

            async function loadServiceMatrix() {
                try {
                    const res = await fetch('/api/admin/service-matrix', { credentials: 'same-origin' });
                    if (!res.ok) throw new Error('Failed to load service matrix');
                    const data = await res.json();
                    renderServiceMatrix(data);
                } catch (err) {
                    console.error('Failed to load service matrix:', err);
                    matrixContainer.innerHTML = '<div class="muted">Error loading service matrix</div>';
                }
            }

            function renderServiceMatrix(data) {
                const teams = data.teams || [];
                const services = data.services || [];
                const boxMap = data.box_map || {};

                if (teams.length === 0 && services.length === 0) {
                    matrixContainer.innerHTML = '<div class="muted">No teams or services configured yet. Configure teams and services first.</div>';
                    return;
                }

                if (teams.length === 0) {
                    matrixContainer.innerHTML = '<div class="muted">No teams configured yet. Go to Teams tab to add teams.</div>';
                    return;
                }

                if (services.length === 0) {
                    matrixContainer.innerHTML = '<div class="muted">No services configured yet. Go to Services tab to add services.</div>';
                    return;
                }

                // Create table
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.minWidth = '600px';

                // Header row with service names
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');

                // First column is team name
                const teamHeader = document.createElement('th');
                teamHeader.textContent = 'Team / Service';
                teamHeader.style.textAlign = 'left';
                teamHeader.style.padding = '12px';
                teamHeader.style.borderBottom = '2px solid rgba(255,255,255,0.1)';
                teamHeader.style.fontWeight = '700';
                teamHeader.style.position = 'sticky';
                teamHeader.style.left = '0';
                teamHeader.style.background = 'var(--card)';
                teamHeader.style.zIndex = '10';
                headerRow.appendChild(teamHeader);

                // Add service columns
                services.forEach(service => {
                    const th = document.createElement('th');
                    th.textContent = service.name || 'Unnamed Service';
                    th.style.textAlign = 'center';
                    th.style.padding = '12px';
                    th.style.borderBottom = '2px solid rgba(255,255,255,0.1)';
                    th.style.fontWeight = '700';
                    th.style.minWidth = '120px';
                    headerRow.appendChild(th);
                });

                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Body rows with teams
                const tbody = document.createElement('tbody');
                teams.forEach(team => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(255,255,255,0.04)';

                    // Team name cell
                    const teamCell = document.createElement('td');
                    teamCell.textContent = team.name;
                    teamCell.style.padding = '12px';
                    teamCell.style.fontWeight = '600';
                    teamCell.style.position = 'sticky';
                    teamCell.style.left = '0';
                    teamCell.style.background = 'var(--card)';
                    teamCell.style.zIndex = '5';
                    row.appendChild(teamCell);

                    // Service status cells
                    services.forEach(service => {
                        const cell = document.createElement('td');
                        cell.style.textAlign = 'center';
                        cell.style.padding = '12px';

                        // Check if this team has this service configured
                        const hasMapping = boxMap[team.id] && boxMap[team.id][service.id];

                        const img = document.createElement('img');
                        if (hasMapping) {
                            img.src = '/static/up.png';
                            img.alt = 'Configured';
                            img.title = `${service.name} is configured for ${team.name} (IP: ${hasMapping.ip_address})`;
                        } else {
                            img.src = '/static/down.png';
                            img.alt = 'Not configured';
                            img.title = `${service.name} is NOT configured for ${team.name}`;
                        }
                        img.style.width = '24px';
                        img.style.height = '24px';
                        img.style.display = 'inline-block';

                        cell.appendChild(img);
                        row.appendChild(cell);
                    });

                    tbody.appendChild(row);
                });

                table.appendChild(tbody);

                matrixContainer.innerHTML = '';
                matrixContainer.appendChild(table);
            }

            // Load matrix when dashboard becomes visible
            window.onDashboardVisible = async function () {
                await loadServiceMatrix();
            };

            // Initial load if dashboard is already visible
            const dashboardSection = document.getElementById('view-dashboard');
            if (dashboardSection && !dashboardSection.hasAttribute('hidden')) {
                loadServiceMatrix();
            }
        })();
    </script>
    <script>
        // Competition management
        (function () {
            const statusText = document.getElementById('comp-status-text');
            const scheduledTimeDiv = document.getElementById('comp-scheduled-time');
            const scheduledText = document.getElementById('comp-scheduled-text');
            const startedTimeDiv = document.getElementById('comp-started-time');
            const startedText = document.getElementById('comp-started-text');
            const stoppedTimeDiv = document.getElementById('comp-stopped-time');
            const stoppedText = document.getElementById('comp-stopped-text');
            const scheduledTimeInput = document.getElementById('scheduled-time-input');
            const scheduleBtn = document.getElementById('schedule-btn');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const resetBtn = document.getElementById('reset-btn');

            let currentCompetition = null;

            async function loadCompetition() {
                try {
                    const res = await fetch('/api/admin/competition', { credentials: 'same-origin' });
                    if (!res.ok) throw new Error('Failed to load competition');
                    currentCompetition = await res.json();
                    updateUI();
                } catch (err) {
                    console.error('Failed to load competition:', err);
                    statusText.textContent = 'Error loading competition';
                }
            }

            function updateUI() {
                if (!currentCompetition) return;

                // Update status with color coding
                const status = currentCompetition.status || 'stopped';
                statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);

                if (status === 'running') {
                    statusText.style.color = '#10b981';
                } else if (status === 'scheduled') {
                    statusText.style.color = '#f59e0b';
                } else {
                    statusText.style.color = '#f97316';
                }

                // Show/hide time fields based on what's available
                if (currentCompetition.scheduled_time) {
                    scheduledTimeDiv.style.display = 'block';
                    scheduledText.textContent = formatDateTime(currentCompetition.scheduled_time);
                } else {
                    scheduledTimeDiv.style.display = 'none';
                }

                if (currentCompetition.started_time) {
                    startedTimeDiv.style.display = 'block';
                    startedText.textContent = formatDateTime(currentCompetition.started_time);
                } else {
                    startedTimeDiv.style.display = 'none';
                }

                if (currentCompetition.stopped_time) {
                    stoppedTimeDiv.style.display = 'block';
                    stoppedText.textContent = formatDateTime(currentCompetition.stopped_time);
                } else {
                    stoppedTimeDiv.style.display = 'none';
                }

                // Enable/disable buttons based on status
                startBtn.disabled = status === 'running';
                stopBtn.disabled = status === 'stopped';
            }

            function formatDateTime(dateStr) {
                if (!dateStr) return '';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleString();
                } catch (e) {
                    return dateStr;
                }
            }

            async function performAction(action, extraData = {}) {
                try {
                    const payload = { action, ...extraData };
                    const res = await fetch('/api/admin/competition', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('Failed to ' + action);
                    await loadCompetition();
                    return true;
                } catch (err) {
                    console.error('Failed to ' + action + ':', err);
                    alert('Failed to ' + action + ': ' + err.message);
                    return false;
                }
            }

            scheduleBtn.addEventListener('click', async () => {
                const scheduledTime = scheduledTimeInput.value;
                if (!scheduledTime) {
                    alert('Please select a date and time');
                    return;
                }
                // Convert to ISO format
                const isoTime = new Date(scheduledTime).toISOString();
                if (await performAction('schedule', { scheduled_time: isoTime })) {
                    scheduledTimeInput.value = '';
                }
            });

            startBtn.addEventListener('click', async () => {
                if (confirm('Start the competition now?')) {
                    await performAction('start');
                }
            });

            stopBtn.addEventListener('click', async () => {
                if (confirm('Stop the competition?')) {
                    await performAction('stop');
                }
            });

            resetBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to reset all scoring data? This will delete all records from the competition_scores table. This action CANNOT be undone!')) {
                    if (await performAction('reset')) {
                        alert('Scoring data has been reset successfully.');
                    }
                }
            });

            // Load competition when view becomes visible
            window.onCompetitionsVisible = async function () {
                await loadCompetition();
            };

            // Initial load if the view is already visible
            const compSection = document.getElementById('view-competitions');
            if (compSection && !compSection.hasAttribute('hidden')) {
                loadCompetition();
            }
        })();
    </script>
</body>

</html>